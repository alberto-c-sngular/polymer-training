<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">

<dom-module id="polymer-training">
  <template>
    <style is="custom-style" include="iron-flex iron-flex-alignment iron-flex-factors">
      :host {
        display: block;
        font-family: sans-serif;
      }

      .header {
        font-weight: bold;
      }

      .new-user-button {
        background-color: rgb(12, 137, 209);
        color: #fff;
        margin: 10px auto;
        width: 130px;
      }

      .new-user-form {
        padding: 10px;
        background: #eee;
        border-radius: 5px;
        margin-top: 15px;
      }

      .new-user-form [header] {
        text-align: center;
        margin-top: 10px;
        font-size: 1.2em;
      }

      .new-user-form paper-input {
        margin: 10px;
      }

      paper-toast {
        background-color: rgb(191, 0, 0);
      }

      paper-icon-button {
        zoom: 0.8;
        color: #00617f;
      }

      .empty-list {
        text-align: center;
        font-size: 1.2em;
        color: #999;
        margin: 45px 0;
      }
    </style>

    <paper-item>
      <div class="header flex-4">Nombre</div>
      <div class="header flex-4">Primer Apellido</div>
      <div class="header flex-2">Edad</div>
      <div class="flex-2"></div>
    </paper-item>

    <template is="dom-if" if="[[!items.length]]">
      <div class="empty-list">La lista está vacía :(</div>
    </template>
    <template is="dom-repeat" items="{{items}}">
      <paper-item style="background:[[__getColorForAge(item.age)]]">
        <div class="flex-4">[[item.firstName]]</div>
        <div class="flex-4">[[item.lastName]]</div>
        <div class="flex-2">[[item.age]]</div>
        <div class="flex-2">
          <paper-icon-button icon="delete" on-click="__removeItem"></paper-icon-button>
        </div>
      </paper-item>
    </template>

    <template is="dom-if" if="[[averageAge]]">
      <paper-item class="layout horizontal center-justified">
        <div>La media de edad es <b>[[averageAge]]</b></div>
      </paper-item>
    </template>



    <div class="new-user-form">
      <div header>Añadir nuevo</div>
      <div class="layout horizontal">
        <paper-input class="flex-5" value="{{newUser.firstName}}" label="Nombre"></paper-input>
        <paper-input class="flex-5" value="{{newUser.lastName}}" label="Primer apellido"></paper-input>
        <paper-input class="flex-2" value="{{newUser.age}}" type="number" label="Edad" min="1" max="120"></paper-input>
      </div>
      <div style="text-align: center">
        <paper-button class="new-user-button" raised on-click="__addNewUser">Añadir</paper-button>
      </div>
    </div>

    <paper-toast id="toast"></paper-toast>
  </template>

  <script>
    /**
     * `polymer-training`
     * 
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class PolymerTraining extends Polymer.Element {
      static get is() { return 'polymer-training'; }
      static get properties() {
        return {
          items: {
            type: Array,
            value: () => []
          },
          averageAge: {
            type: Number,
            computed: '__calculateAverageAge(items.splices)'
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this.newUser = this.__getEmptyUser();
      }

      __removeItem(e) {
        this.splice('items', this.items.indexOf(e.model.item), 1);
      }
      __getEmptyUser() {
        return {
          firstName: '',
          lastName: '',
          age: 1
        }
      }
      __calculateAverageAge() {
        return this.items.length == 0 ? 0 :
          Math.floor((this.items.reduce((acc, next) => acc + parseInt(next.age), 0) / this.items.length) * 100) / 100;
      }
      __addNewUser() {
        if (isNaN(parseInt(this.newUser.age)) || parseInt(this.newUser.age) < 1) {
          this.$.toast.text = "Introduce una edad válida";
          this.$.toast.show();
          return;
        }
        this.push('items', {
          firstName: this.newUser.firstName,
          lastName: this.newUser.lastName,
          age: parseInt(this.newUser.age)
        });
        this.newUser = this.__getEmptyUser();
      }
      __getColorForAge(age) {
        if (age < 20) {
          return '#fff';
        } else if (age < 30) {
          return '#eff7f7';
        } else if (age < 40) {
          return '#cbf2f2';
        }
        return '#88efef';
      }
    }

    window.customElements.define(PolymerTraining.is, PolymerTraining);
  </script>
</dom-module>