<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="user-card.html">

<dom-module id="user-list">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
      }
      #errorMessage {
        padding: 1em;
        background: crimson;
        color: white;
      }
    </style>
    <h3>Añadir usuario</h3>
    <paper-input id="nombre" label="Nombre" required></paper-input>
    <paper-input id="apellidos" label="Primer Apellido" required></paper-input>
    <paper-input id="edad" type="number" label="Edad" min="0" required></paper-input>
    <p id="errorMessage" hidden><b>Error | </b> [[errorMessage]]</p>   
    <paper-button on-click="_addUser" raised>Añadir</paper-button>
    <hr>    
    <template is="dom-repeat" items="[[users]]" as="user">
      <user-card user="[[user]]" on-remove-user="_removeUser"></user-card>
    </template>
    <hr>
    <b>Media edad: </b> [[mediaEdad]]
  </template>

  <script>
    /**
     * `user-list`
     * Lista de usuarios
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class UserList extends Polymer.Element {
      static get is() { return 'user-list'; }
      static get properties() {
        return {
          users: {
            type: Array,
            value: () => []
          },
          mediaEdad: {
            type: Number,
            computed: '_mediaEdad(users.splices)'
          }
        };
      }
      constructor() {
        super();
        this.contador = 0;
      }

      _mediaEdad() {
        return this.users
          .reduce( (total, actual) => total + actual.edad, 0) / this.users.length || 0;
      }

      _validateInputs() {
        if( !this.$.nombre.value ) {
          this.errorMessage = "El nombre es necesario";
          this.$.errorMessage.removeAttribute('hidden');
          return false;
        }
        if( !this.$.apellidos.value) {
          this.errorMessage = "El apellido es necesario";
          this.$.errorMessage.removeAttribute('hidden');
          return false;
        }
        if( !this.$.edad.value || +this.$.edad.value < 0) {
          this.errorMessage = "La edad es necesaria";
          this.$.errorMessage.removeAttribute('hidden');
          return false;
        }
        this.$.errorMessage.setAttribute('hidden', '');
        return true;
      }

      _cleanForm() {
        this.$.nombre.value = null;
        this.$.apellidos.value = null;
        this.$.edad.value = null;
      }

      _addUser(evt) {
        if (!this._validateInputs()) return;

        this.push('users', {
          id: this.contador++,
          nombre: this.$.nombre.value,
          apellidos: this.$.apellidos.value,
          edad: +this.$.edad.value
        });

        this._cleanForm();
      }

      _removeUser(evt) {
        const userToRemove = evt.detail;
        this.set('users',
          this.users.filter(
            user => user.id !== userToRemove.id
          )
        );
      }
    }

    window.customElements.define(UserList.is, UserList);
  </script>
</dom-module>
