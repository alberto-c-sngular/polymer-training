<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-request.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="people-list-form.html">

<dom-module id="people-list-app">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        font-family: 'Roboto', sans-serif;
        padding: 1rem;
      }

      li {
        padding: .5rem 1rem;
        margin-bottom: 1px;
      }
      people-list-form {
        margin-top: 2rem;
      }

      .loading {
        position: absolute;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #fff;
        z-index: 9999
      }

      .loading span {
        padding-left: 1rem;
      }

      .gt-39 {
        background-color: #88efef;
      }

      .gt-29 {
        background-color: #cbf2f2;
      }

      .gt-19 {
        background-color: #eff7f7;
      }

      .lte-19 {
        background-color: #fff;
      }

      .note {
        color: #666;
        font-size: .9rem;
        font-style: italic;
        padding: 0 1rem;
      }
    </style>

    <iron-request id="xhr"></iron-request>

    <template is="dom-if" if="[[loading]]">
      <div class="loading">
        <paper-spinner alt="Loading users..." active="true"></paper-spinner>
        <span>Loading...</span>
      </div>
    </template>

    <h1>People list</h2>

    <ul>
      <template is="dom-repeat" items="{{people}}">
        <li class$="[[item.className]]">
          [[item.firstName]] [[item.lastName]] ([[item.age]])
        </li>
      </template>
    </ul>

    <p class="note">People average age: <strong>{{ageAverage}}</strong></p>

    <people-list-form id="form" on-people-list-add="_add"></people-list-form>

  </template>

  <script>
    class PeopleListApp extends Polymer.Element {
      static get is() { return 'people-list-app'; }

      static get properties () {
        return {
          ageAverage: {
            type: Number,
            computed: '_peopleChanged(people.splices)'
          },
          loading: {
            type: Boolean,
            value: true
          },
          people: {
            type: Array
          }
        };
      }

      ready () {
        super.ready();
        this._getData();
      }

      _add () {
        const newPerson = Object.assign({}, this.$.form.payload);

        newPerson.bgColor = this._getClassName(newPerson.age);
        this.push('people', newPerson);
      }

      _calculateAverage () {
        const accumulate = this.people.reduce((acc, person) => acc + parseInt(person.age, 10), 0);
        const formattedValue = (accumulate / this.people.length).toFixed(1);

        return formattedValue;
      }

      _fillInitialList (data) {
        this.people = data.map(item => {
          const className = this._getClassName(item.dob.age);

          return {
            firstName: item.name.first,
            lastName: item.name.last,
            age: item.dob.age,
            className: className
          }
        });
      }

      _getClassName (age, range, classNames) {
        const _classNames = classNames || ['lte-19', 'gt-19', 'gt-29', 'gt-39'];
        let _range = range || 39;
        let color;

        if (_classNames.length === 1) {
          return _classNames[0];
        }

        if (age > _range) {
          return  _classNames.pop();
        }

        _classNames.length = _classNames.length - 1;
        _range = _range - 10;

        return this._getClassName(age, _range, _classNames);
      }

      _getData () {
        const request = this.$.xhr.send({ url: 'https://randomuser.me/api/?results=10' });
        this.$.xhr.completes.then(
          request => {
            const response = JSON.parse(request.response);

            this._fillInitialList(response.results);
            this.loading = false;
          },
          rejected => {
            console.error(rejected.error);
          }
        );
      }

      _peopleChanged () {
        return this._calculateAverage();
      }
    }

    window.customElements.define(PeopleListApp.is, PeopleListApp);
  </script>
</dom-module>
